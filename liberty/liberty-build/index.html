



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Liberty - Build - Application Modernization</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#liberty-build" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Application Modernization" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Application Modernization
            </span>
            <span class="md-header-nav__topic">
              
                Liberty - Build
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    ibm-cloud-architecture/cloudpak-for-applications
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Application Modernization" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Application Modernization
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    ibm-cloud-architecture/cloudpak-for-applications
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../" title="Runtime modernization" class="md-nav__link">
      Runtime modernization
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../spring/" title="Spring modernization" class="md-nav__link">
      Spring modernization
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../was90/" title="Operational modernization" class="md-nav__link">
      Operational modernization
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-changes" class="md-nav__link">
    Code changes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-websphere-liberty-serverxml-file" class="md-nav__link">
    Create the WebSphere Liberty server.xml file
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#environment-specific-configuration" class="md-nav__link">
    Environment Specific Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring" class="md-nav__link">
    Monitoring
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kubernetes-monitoring" class="md-nav__link">
    Kubernetes Monitoring
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#application-monitoring" class="md-nav__link">
    Application Monitoring
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics-scraping-with-websphere-liberty" class="md-nav__link">
    Metrics scraping with WebSphere Liberty
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prometheus-jmx-exporter" class="md-nav__link">
    Prometheus JMX exporter
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#project-structure" class="md-nav__link">
    Project Structure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-docker-dockerfile" class="md-nav__link">
    Create the Docker Dockerfile
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-the-application-locally" class="md-nav__link">
    Run the application locally
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#review-and-next-steps" class="md-nav__link">
    Review and Next Steps
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/edit/master/docs/liberty/liberty-build.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="liberty-build">Liberty - Build</h1>
<p>This section covers how to make the minimal code changes required to allow the application to run on the Liberty runtime and how to create the configuration required for the Liberty runtime. The Liberty runtime and Docker image configuration will take in to account factors such as the requirement to inject environment specific configuration (such as JDBC Datasource User IDs and Passwords) at runtime and how to integrate with the Logging and Monitoring framework of the Cloud platform.</p>
<p>The final versions of the files created in this section can be found in the <code>liberty</code> branch of <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/tree/liberty">this repo</a></p>
<h2 id="summary">Summary</h2>
<p>This section has the following steps:</p>
<ol>
<li>
<p>Make minimal code changes to the application based on the analysis from IBM Cloud Transformation Advisor</p>
</li>
<li>
<p>Create the WebSphere Liberty configuration file <code>server.xml</code> for the Customer Order Services application. This includes:</p>
<ul>
<li>listing the WebSphere Liberty runtime features that are required</li>
<li>configuring a DB2 Data Source</li>
<li>configuring a local user registry</li>
<li>using environment variables in the <code>server.xml</code> file to allow configuration to be injected in to the runtime environment dynamically such as the DB2 user and password.  </li>
</ul>
</li>
<li>
<p>Configuring WebSphere Liberty to expose internal metrics in a way that they can be collected by Prometheus</p>
</li>
<li>
<p>Creating a <code>Dockerfile</code> and running the application in a Docker container locally</p>
</li>
</ol>
<h2 id="code-changes">Code changes</h2>
<p>In the previous section IBM Cloud Transformation Advisor highlighted a change in the way that Enterprise JavaBeans are looked up in Liberty.</p>
<p><strong>Behavior change on lookups for Enterprise JavaBeans</strong> In Liberty, EJB components are not bound to a server root Java Naming and Directory Interface (JNDI) namespace as they are in WebSphere Application Server traditional. The fix for this is to change the three classes that use <code>ejblocal</code> to use the correct URL for Liberty</p>
<p>The three Java classes that should be modified to look up Enterprise JavaBeans differently are shown in the detailed analysis view of IBM Cloud Transformation Advisor (it isn't necessary to change the <code>ibm-web-bnd.xml</code> file in the <code>Test</code> project in this scenario) to be in the <code>CustomerOrderServicesWeb</code> project</p>
<p><img alt="Analysis" src="../images/liberty-build/analysis.jpg" /></p>
<p><code>org.pwte.example.resources.CategoryResource.java</code> is changed from using <code>ejblocal</code> on line 28 as shown below:</p>
<div class="codehilite"><pre><span></span><span class="o">...</span>
<span class="n">InitialContext</span><span class="o">().</span><span class="na">lookup</span><span class="o">(</span><span class="s">&quot;ejblocal:org.pwte.example.service.ProductSearchService&quot;</span><span class="o">);</span>
<span class="o">...</span>
</pre></div>


<p>to use <code>java:app</code> as shown below:</p>
<div class="codehilite"><pre><span></span><span class="o">...</span>
<span class="n">InitialContext</span><span class="o">().</span><span class="na">lookup</span><span class="o">(</span><span class="s">&quot;java:app/CustomerOrderServices/ProductSearchServiceImpl!org.pwte.example.service.ProductSearchService&quot;</span><span class="o">);</span>
<span class="o">...</span>
</pre></div>


<p>line 53 of <code>org.pwte.example.resources.CustomerOrderResource.java</code> is changed as shown below:</p>
<div class="codehilite"><pre><span></span><span class="o">...</span>
<span class="n">ctx</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">&quot;java:app/CustomerOrderServices/CustomerOrderServicesImpl!org.pwte.example.service.CustomerOrderServices&quot;</span><span class="o">);</span>
<span class="o">...</span>
</pre></div>


<p>line 38 of <code>org.pwte.example.resources.ProductResource.java</code> is changed as shown below:</p>
<div class="codehilite"><pre><span></span><span class="o">...</span>
<span class="n">InitialContext</span><span class="o">().</span><span class="na">lookup</span><span class="o">(</span><span class="s">&quot;java:app/CustomerOrderServices/ProductSearchServiceImpl!org.pwte.example.service.ProductSearchService&quot;</span><span class="o">);</span>
<span class="o">...</span>
</pre></div>


<p>This completes all of the required code changes for the Customer Order Services application to run on the WebSphere Liberty runtime.</p>
<h2 id="create-the-websphere-liberty-serverxml-file">Create the WebSphere Liberty server.xml file</h2>
<p>WebSphere Liberty is configured by exception. The runtime environment operates from a set of built-in configuration default settings, and you only need to specify configuration that overrides those default settings. You do this by editing either the <code>server.xml</code> file or another XML file that is included in <code>server.xml</code> at run time. The configuration has the following characteristics:</p>
<ul>
<li>Described in XML files.</li>
<li>Human-readable, and editable in a text editor.</li>
<li>Small, easy to back up, and easy to copy to another system.</li>
<li>Shareable across an application development team.</li>
<li>Composable, so that features can easily add their own configuration to the system.</li>
<li>Extensibly-typed, so you don't have to modify the current configuration to work with later versions of the runtime environment.</li>
<li>Dynamically responsive to updates.</li>
<li>Forgiving, so that missing values are assumed and unrecognized properties are ignored.</li>
</ul>
<p><strong>Features</strong> are the units of functionality by which you control the pieces of the runtime environment that are loaded into a particular server. They are the primary mechanism that makes the server composable. The list of features that you specify in the server configuration provides a functional server. See <a href="https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/rwlp_feat.html">Liberty features</a> for more information.</p>
<p>In this section, the <code>server.xml</code> file to prepare the Liberty server to run the Customer Order Services application will be reviewed. The file can be found <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/liberty/liberty/server.xml">here</a>. and is shown below:</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;server&gt;</span>
  <span class="nt">&lt;featureManager&gt;</span>
      <span class="nt">&lt;feature&gt;</span>appSecurity-2.0<span class="nt">&lt;/feature&gt;</span>
      <span class="nt">&lt;feature&gt;</span>ldapRegistry-3.0<span class="nt">&lt;/feature&gt;</span>
      <span class="nt">&lt;feature&gt;</span>localConnector-1.0<span class="nt">&lt;/feature&gt;</span>
      <span class="nt">&lt;feature&gt;</span>ejbLite-3.1<span class="nt">&lt;/feature&gt;</span>
      <span class="nt">&lt;feature&gt;</span>jaxrs-1.1<span class="nt">&lt;/feature&gt;</span>
      <span class="nt">&lt;feature&gt;</span>jdbc-4.1<span class="nt">&lt;/feature&gt;</span>
      <span class="nt">&lt;feature&gt;</span>jpa-2.0<span class="nt">&lt;/feature&gt;</span>
      <span class="nt">&lt;feature&gt;</span>jsp-2.3<span class="nt">&lt;/feature&gt;</span>
      <span class="nt">&lt;feature&gt;</span>servlet-3.1<span class="nt">&lt;/feature&gt;</span>
      <span class="nt">&lt;feature&gt;</span>monitor-1.0<span class="nt">&lt;/feature&gt;</span>
  <span class="nt">&lt;/featureManager&gt;</span>

  <span class="nt">&lt;library</span> <span class="na">id=</span><span class="s">&quot;DB2Lib&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;fileset</span> <span class="na">dir=</span><span class="s">&quot;/opt/ibm/wlp/usr/shared/resources/db2&quot;</span> <span class="na">includes=</span><span class="s">&quot;db2jcc4.jar db2jcc_license_cu.jar&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/library&gt;</span>

  <span class="nt">&lt;dataSource</span> <span class="na">id=</span><span class="s">&quot;OrderDS&quot;</span> <span class="na">jndiName=</span><span class="s">&quot;jdbc/orderds&quot;</span> <span class="na">type=</span><span class="s">&quot;javax.sql.XADataSource&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;jdbcDriver</span> <span class="na">libraryRef=</span><span class="s">&quot;DB2Lib&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;properties.db2.jcc</span> <span class="na">databaseName=</span><span class="s">&quot;${env.DB2_DBNAME}&quot;</span> <span class="na">password=</span><span class="s">&quot;${env.DB2_PASSWORD}&quot;</span> <span class="na">portNumber=</span><span class="s">&quot;${env.DB2_PORT}&quot;</span> <span class="na">serverName=</span><span class="s">&quot;${env.DB2_HOST}&quot;</span> <span class="na">user=</span><span class="s">&quot;${env.DB2_USER}&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;connectionManager</span> <span class="na">agedTimeout=</span><span class="s">&quot;0&quot;</span> <span class="na">connectionTimeout=</span><span class="s">&quot;180&quot;</span> <span class="na">maxIdleTime=</span><span class="s">&quot;1800&quot;</span> <span class="na">maxPoolSize=</span><span class="s">&quot;10&quot;</span> <span class="na">minPoolSize=</span><span class="s">&quot;1&quot;</span> <span class="na">reapTime=</span><span class="s">&quot;180&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/dataSource&gt;</span>

  <span class="nt">&lt;httpEndpoint</span> <span class="na">host=</span><span class="s">&quot;*&quot;</span> <span class="na">httpPort=</span><span class="s">&quot;9080&quot;</span> <span class="na">httpsPort=</span><span class="s">&quot;9443&quot;</span> <span class="na">id=</span><span class="s">&quot;defaultHttpEndpoint&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tcpOptions</span> <span class="na">soReuseAddr=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/httpEndpoint&gt;</span>

  <span class="nt">&lt;keyStore</span> <span class="na">id=</span><span class="s">&quot;defaultKeyStore&quot;</span> <span class="na">password=</span><span class="s">&quot;whodunit&quot;</span><span class="nt">/&gt;</span>
  <span class="c">&lt;!-- User and group security definitions --&gt;</span>

  <span class="nt">&lt;basicRegistry</span> <span class="na">id=</span><span class="s">&quot;basic&quot;</span> <span class="na">realm=</span><span class="s">&quot;customRealm&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;user</span> <span class="na">name=</span><span class="s">&quot;rbarcia&quot;</span> <span class="na">password=</span><span class="s">&quot;bl0wfish&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;group</span> <span class="na">name=</span><span class="s">&quot;SecureShopper&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;member</span> <span class="na">name=</span><span class="s">&quot;rbarcia&quot;</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;/group&gt;</span>
  <span class="nt">&lt;/basicRegistry&gt;</span>

  <span class="nt">&lt;applicationMonitor</span> <span class="na">updateTrigger=</span><span class="s">&quot;mbean&quot;</span><span class="nt">/&gt;</span>

  <span class="nt">&lt;application</span> <span class="na">id=</span><span class="s">&quot;customerOrderServicesApp&quot;</span> <span class="na">name=</span><span class="s">&quot;CustomerOrderServicesApp-0.1.0-SNAPSHOT.ear&quot;</span> <span class="na">type=</span><span class="s">&quot;ear&quot;</span> <span class="na">location=</span><span class="s">&quot;CustomerOrderServicesApp-0.1.0-SNAPSHOT.ear&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;classloader</span> <span class="na">apiTypeVisibility=</span><span class="s">&quot;spec, ibm-api, third-party&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/application&gt;</span>

<span class="nt">&lt;/server&gt;</span>
</pre></div>


<p>The <code>features</code> section contains the following features:</p>
<ul>
<li><code>ejbLite-3.1</code>: the feature required to run simple Stateless Session Enterprise Java Beans</li>
<li><code>jpa-2.0</code>, <code>jdbc-4.1</code>: the features required for the JPA 2.0 runtime</li>
<li><code>jaxrs-1-1</code>: the feature required for the JAX-RS 1.1 runtime</li>
<li><code>servlet-3.1</code>, <code>jsp-2.3</code>: the features required for Servlets and JSPs</li>
<li><code>ldapRegistry-3.0</code>, <code>appSecurity-2.0</code>: the features required to secure access to the application using LDAP or a local user registry</li>
<li><code>monitor-1.0</code>: this feature enables the Performance Monitoring Infrastructure (PMI) for other features the server is running. Monitoring data is accessible through standard MXBeans.</li>
</ul>
<p>The <code>library</code> and <code>dataSource</code> sections configure a <code>JDBC Driver</code> for DB2 and a <code>DataSource</code> for the database used by the application. Note that some values have a <code>{env.}</code> prefix which is used to allow the values to be read from the environment instead of being hard-coded. This will be discussed in more detail in the <strong>Environment Specific Configuration</strong> section later.</p>
<p>The <code>basicRegistry</code> section configures a local user registry with a single user (<code>rbarcia</code>) and a single group (<code>SecureShopper</code>). This is often used for development and testing when an LDAP server isn't available and is sufficient for this scenario.</p>
<p>The <code>applicationMonitor</code> tag is used with Eclipse and triggers the application to be reloaded when a deployment from Eclipse occurs.</p>
<p>The <code>application</code> tag describes the CustomerOrderServices EAR with an <code>id</code>, <code>name</code> and <code>location</code>. In this case the default location of the <code>apps</code> folder is used. The <code>classloader</code> tag is used to allow the application access to the Java Classes that make up the JEE specification (<code>spec</code>), some IBM provided APIs (<code>ibm-api</code>) and third-party classes such as <code>apache-wink</code> as these classes are hidden from the application by default.</p>
<p>The <code>classloader</code> is configured becuase IBM Cloud Transformation Advisor highlighted that the application needed access to the Apach Wink APIs:</p>
<p><strong>The user of system provided Apache Wink APIs requires configuration</strong> To use system-provided third-party APIs in Liberty applications, you must configure the applications to include the APIs. In WebSphere Application Server traditional, these APIs are available without configuration. This is a configuration only change and can be achieved by using a <code>classloader</code> definition in the Liberty server.xml file.</p>
<h3 id="environment-specific-configuration">Environment Specific Configuration</h3>
<p>Applications deployed to an Application Server typically require access to backend services such as Databases, Message Queues, LDAP servers and other applications. Connection information for the backend services might include URL, Hostname, Port, UserID and Password and this information is often different depending on the environment (e.g. Dev, Test or Production) that the application is deployed to. In the case of the Customer Order Services application, a connection to a DB2 database is required.</p>
<p>In order to take advantage of the portability provided by a platform such as Kubernetes and the speed of DevOps it is necessary to deploy applications in <strong>immutable</strong> containers using automation.</p>
<p>In this context, <strong>immutable</strong> means that a container will not be modified during its life: no updates, no patches, no configuration changes. If you need to update the application code or apply a patch, you build a new image and deploy it. In order to achieve this, it is necessary to inject environment specific configuration in to the container in each environment (Database UserIDs and Passwords for example) instead of hard-coding the values in properties files in the container.</p>
<p>The goal is to deploy the application in a portable, immutable container and in order to achieve that any <strong>environment specific</strong> configuration should be externalized from the container image and injected by the platform. In the Kubernetes world this is achieved using Environment Variables, ConfigMaps and Secrets.</p>
<p>Using the <code>env.</code> prefex in the WebSphere Liberty <code>server.xml</code> forces the runtime to use the value of the environment variable when the server starts. See the <a href="https://www.ibm.com/support/knowledgecenter/en/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_setup_vars.html">documentation</a> for more details. In the snippet below from the Customer Order Services application <code>server.xml</code> file, the <code>host</code>, <code>portNumber</code>, <code>databaseName</code>, <code>user</code> and <code>password</code> have all been externalized as <strong>environment variables</strong> which allows this application image to be moved between environments that have different databases without changing the image.</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;dataSource</span> <span class="na">id=</span><span class="s">&quot;OrderDS&quot;</span> <span class="na">jndiName=</span><span class="s">&quot;jdbc/orderds&quot;</span> <span class="na">type=</span><span class="s">&quot;javax.sql.XADataSource&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;jdbcDriver</span> <span class="na">libraryRef=</span><span class="s">&quot;DB2Lib&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;properties.db2.jcc</span> <span class="na">databaseName=</span><span class="s">&quot;${env.DB2_DBNAME}&quot;</span> <span class="na">password=</span><span class="s">&quot;${env.DB2_PASSWORD}&quot;</span> <span class="na">portNumber=</span><span class="s">&quot;${env.DB2_PORT}&quot;</span> <span class="na">serverName=</span><span class="s">&quot;${env.DB2_HOST}&quot;</span> <span class="na">user=</span><span class="s">&quot;${env.DB2_USER}&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;connectionManager</span> <span class="na">agedTimeout=</span><span class="s">&quot;0&quot;</span> <span class="na">connectionTimeout=</span><span class="s">&quot;180&quot;</span> <span class="na">maxIdleTime=</span><span class="s">&quot;1800&quot;</span> <span class="na">maxPoolSize=</span><span class="s">&quot;10&quot;</span> <span class="na">minPoolSize=</span><span class="s">&quot;1&quot;</span> <span class="na">reapTime=</span><span class="s">&quot;180&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/dataSource&gt;</span>
</pre></div>


<p>In a native development environment (non-Docker) a <code>server.env</code> file can be used to inject the environment variables directly in to WebSphere Liberty when it starts. This avoids having to set environment variables on the development machine. This file is placed in the same folder as the <code>server.xml</code> file and is read by Liberty on startup. The file can be found <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/liberty/liberty/server.env">here</a>. and is shown below:</p>
<div class="codehilite"><pre><span></span><span class="n">DB2_HOST</span><span class="o">=</span><span class="mi">172</span><span class="p">.</span><span class="mi">16</span><span class="p">.</span><span class="mi">52</span><span class="p">.</span><span class="mi">252</span>
<span class="n">DB2_PORT</span><span class="o">=</span><span class="mi">50000</span>
<span class="n">DB2_DBNAME</span><span class="o">=</span><span class="n">ORDERDB</span>
<span class="n">DB2_USER</span><span class="o">=</span><span class="n">db2inst1</span>
<span class="n">DB2_PASSWORD</span><span class="o">=</span><span class="n">db2inst1</span>
</pre></div>


<h3 id="monitoring">Monitoring</h3>
<p><a href="https://prometheus.io/">Prometheus</a> and <a href="https://grafana.com">Grafana</a> are used by the IBM CloudPak for Application to monitor applications running in Kubernetes. Prometheus is a systems and service monitoring system. It collects metrics from configured targets at given intervals, evaluates rule expressions, displays the results, and can trigger alerts if some condition is observed to be true.</p>
<p>Prometheus has several components for the collection of Time Series Data, an Alert Manager and a central Prometheus Server which scrapes and stores the data. The data is visualized using a Grafana instance.</p>
<h4 id="kubernetes-monitoring">Kubernetes Monitoring</h4>
<p>Prometheus can monitor Kubernetes and the application pods. For Kubernetes data is related to the overall cluster state such as pod state (running, pending, error etc), cluster CPU usage and cluster RAM usage. Individual pod data is also available including CPU and RAM usage. This data is useful for an overall cluster view but it doesn't provide application specific data.</p>
<p><img alt="Analysis" src="../images/liberty-build/grafana-basic.jpg" /></p>
<h4 id="application-monitoring">Application Monitoring</h4>
<p>Prometheus can pull metrics data from applications using <strong>scraping</strong>. It is the responsibility of the application to make their metrics available on a <code>/metrics</code> endpoint which Prometheus <em>scrapes</em> and stores the data in its database for later visualization using Grafana.</p>
<p>An example of the results from a <code>/metrics</code> scrape are shown below. Metrics related to connection pools, thread pools, CPU, memory and JVM heap usage are more useful for a Java application that the basic pod metrics available by default.</p>
<div class="codehilite"><pre><span></span><span class="n">base</span><span class="o">:</span><span class="n">classloader_current_loaded_class_count</span> <span class="mi">16266</span>
<span class="n">base</span><span class="o">:</span><span class="n">classloader_total_loaded_class_count</span> <span class="mi">16372</span>
<span class="n">base</span><span class="o">:</span><span class="n">classloader_total_unloaded_class_count</span> <span class="mi">106</span>
<span class="n">base</span><span class="o">:</span><span class="n">cpu_available_processors</span> <span class="mi">8</span>
<span class="n">base</span><span class="o">:</span><span class="n">cpu_process_cpu_load_percent</span> <span class="mf">8.262355256251326</span><span class="n">E</span><span class="o">-</span><span class="mi">4</span>
<span class="n">base</span><span class="o">:</span><span class="n">gc_global_count</span> <span class="mi">245</span>
<span class="n">base</span><span class="o">:</span><span class="n">gc_global_time_seconds</span> <span class="mf">13.756</span>
<span class="n">base</span><span class="o">:</span><span class="n">gc_scavenge_count</span> <span class="mi">9467</span>
<span class="n">base</span><span class="o">:</span><span class="n">gc_scavenge_time_seconds</span> <span class="mf">21.759</span>
<span class="n">base</span><span class="o">:</span><span class="n">jvm_uptime_seconds</span> <span class="mf">346146.925</span>
<span class="n">base</span><span class="o">:</span><span class="n">memory_committed_heap_bytes</span> <span class="mf">7.1892992E7</span>
<span class="n">base</span><span class="o">:</span><span class="n">memory_max_heap_bytes</span> <span class="mf">5.36870912E8</span>
<span class="n">base</span><span class="o">:</span><span class="n">memory_used_heap_bytes</span> <span class="mf">5.0641512E7</span>
<span class="n">base</span><span class="o">:</span><span class="n">thread_count</span> <span class="mi">77</span>
<span class="n">base</span><span class="o">:</span><span class="n">thread_daemon_count</span> <span class="mi">74</span>
<span class="n">base</span><span class="o">:</span><span class="n">thread_max_count</span> <span class="mi">91</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">connectionpool_jdbc_orderds_connection_handles</span> <span class="mi">0</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">connectionpool_jdbc_orderds_create_total</span> <span class="mi">7</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">connectionpool_jdbc_orderds_destroy_total</span> <span class="mi">7</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">connectionpool_jdbc_orderds_free_connections</span> <span class="mi">0</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">connectionpool_jdbc_orderds_in_use_time_total_seconds</span> <span class="mf">0.71</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">connectionpool_jdbc_orderds_managed_connections</span> <span class="mi">0</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">connectionpool_jdbc_orderds_queued_requests_total</span> <span class="mi">0</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">connectionpool_jdbc_orderds_used_connections_total</span> <span class="mi">7</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">connectionpool_jdbc_orderds_wait_time_total_seconds</span> <span class="mf">0.0</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">servlet_com_ibm_ws_microprofile_metrics_public_public_metrics_rest_proxy_servlet_request_total</span> <span class="mi">5771</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">servlet_com_ibm_ws_microprofile_metrics_public_public_metrics_rest_proxy_servlet_response_time_total_seconds</span> <span class="mf">27.157690424000002</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">servlet_customer_order_services_app_org_pwte_example_app_customer_services_app_request_total</span> <span class="mi">6</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">servlet_customer_order_services_app_org_pwte_example_app_customer_services_app_response_time_total_seconds</span> <span class="mf">1.889112088</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">session_default_host_metrics_active_sessions</span> <span class="mi">0</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">session_default_host_metrics_create_total</span> <span class="mi">1</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">session_default_host_metrics_invalidated_total</span> <span class="mi">1</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">session_default_host_metrics_invalidatedby_timeout_total</span> <span class="mi">1</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">session_default_host_metrics_live_sessions</span> <span class="mi">0</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">threadpool_default_executor_active_threads</span> <span class="mi">1</span>
<span class="n">vendor</span><span class="o">:</span><span class="n">threadpool_default_executor_size</span> <span class="mi">24</span>
</pre></div>


<h4 id="metrics-scraping-with-websphere-liberty">Metrics scraping with WebSphere Liberty</h4>
<p>WebSphere Liberty provides a <code>monitoring-1.0</code> feature which enables the Performance Monitoring Infrastructure (PMI) for other features the server is running and makes the monitoring data available via MXBeans. <strong>Prometheus cannot scrape MXBeans</strong>.</p>
<p>WebSphere Liberty also provides a <code>mpMetrics</code> feature which takes the data from the MXBeans and exposes it on a <code>/metrics</code> endpoint that can be read by Prometheus. <strong>However, the mpMetrics feature is only available to applications using JavaEE7 or newer features.</strong></p>
<p>The Customer Order Services application uses the <code>jpa-2.0</code>, <code>jaxrs-1.1</code> and <code>ejbLite-3.1</code> features which are older than JavaEE7 and is therefore unable to use the <code>mpMetrics</code> feature and can't expose a <code>/metrics</code> endpoint for Prometheus.</p>
<h4 id="prometheus-jmx-exporter">Prometheus JMX exporter</h4>
<p>A solution to the problem that the Customer Order Services application has is to use <a href="https://github.com/prometheus/jmx_exporter">Prometheus JMX exporter</a>. The Prometheus JMX exporter connects to any MXBeans on a JVM, retrieves their data and exposes the results on a <code>/metrics</code> endpoint so that the data can be scraped by Prometheus.  </p>
<p>The JMX exporter is made up of a <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/tree/liberty/resources/jmx_exporter">JAR file</a> and a <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/liberty/resources/jmx_exporter/jmx-config.yml">configuration file</a>. The configuration file used for the Customer Order Services application is shown below.</p>
<div class="codehilite"><pre><span></span><span class="c1">---</span>
<span class="n">startDelaySeconds</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">ssl</span><span class="p">:</span> <span class="k">false</span>
<span class="n">lowercaseOutputName</span><span class="p">:</span> <span class="k">false</span>
<span class="n">lowercaseOutputLabelNames</span><span class="p">:</span> <span class="k">false</span>
</pre></div>


<p>In order to connect the JMX exporter and configuration file to Liberty on startup, a <code>jvm.options</code> file is required. The <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/liberty/liberty/jvm.options">jvm.options</a> file is shown below.</p>
<div class="codehilite"><pre><span></span><span class="o">-</span><span class="n">javaagent</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">wlp</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">resources</span><span class="o">/</span><span class="n">jmx_exporter</span><span class="o">/</span><span class="n">jmx_prometheus_javaagent</span><span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="n">jar</span><span class="o">=</span><span class="mi">9081</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">wlp</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">resources</span><span class="o">/</span><span class="n">jmx_exporter</span><span class="o">/</span><span class="n">jmx</span><span class="o">-</span><span class="n">config</span><span class="p">.</span><span class="n">yml</span>
</pre></div>


<p>An example of the dashboard that is now possible in Grafana is shown below. In this case the dashboard shows data about Servlets and Thread Pools.</p>
<p><img alt="Dashboard" src="../images/liberty-build/new-dashboard.jpg" /></p>
<p>More details related to the metrics exposed by WebSphere Liberty and how to visualize them with Grafana will be covered in the <a href="../liberty-deploy/"><strong>Liberty - Deploy</strong> section</a></p>
<h2 id="project-structure">Project Structure</h2>
<p>The git project for the Customer Order Services application already has the following structure:</p>
<div class="codehilite"><pre><span></span><span class="err">├──</span> <span class="n">CustomerOrderServices</span>
<span class="o">|</span>   <span class="err">├──</span> <span class="n">ejbModule</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="err">└──</span> <span class="o">&lt;</span><span class="k">source</span> <span class="n">code</span><span class="o">&gt;</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">pom</span><span class="p">.</span><span class="n">xml</span>
<span class="err">├──</span> <span class="n">CustomerOrderServicesApp</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">META</span><span class="o">-</span><span class="n">INF</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="err">└──</span> <span class="o">&lt;</span><span class="k">descriptor</span> <span class="n">files</span><span class="o">&gt;</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">pom</span><span class="p">.</span><span class="n">xml</span>
<span class="err">├──</span> <span class="n">CustomerOrderServiceProject</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">pom</span><span class="p">.</span><span class="n">xml</span>
<span class="err">├──</span> <span class="n">CustomerOrderServiceTest</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">WebContent</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">src</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="err">└──</span> <span class="o">&lt;</span><span class="k">source</span> <span class="n">code</span><span class="o">&gt;</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">pom</span><span class="p">.</span><span class="n">xml</span>
<span class="err">└──</span> <span class="n">CustomerOrderServiceWeb</span>
    <span class="err">├──</span> <span class="n">WebContent</span>
    <span class="err">├──</span> <span class="n">src</span>
    <span class="o">|</span>   <span class="err">└──</span> <span class="o">&lt;</span><span class="k">source</span> <span class="n">code</span><span class="o">&gt;</span>
    <span class="err">└──</span> <span class="n">pom</span><span class="p">.</span><span class="n">xml</span>
</pre></div>


<p>It is now necessary to add the WebSphere Liberty, DB2 and JMX Exporter files to the git project so that they can be pulled in to the Docker image during Docker build.</p>
<p>The following folders and files have been added to the project:</p>
<div class="codehilite"><pre><span></span><span class="err">├──</span> <span class="n">resources</span>
<span class="o">|</span>   <span class="err">├──</span> <span class="n">db2</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="err">└──</span> <span class="n">db2jcc4</span><span class="p">.</span><span class="n">jar</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="err">└──</span> <span class="n">db2jcc_license_cu</span><span class="p">.</span><span class="n">jar</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">jmx_exporter</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="err">└──</span> <span class="n">jmx</span><span class="o">-</span><span class="n">config</span><span class="p">.</span><span class="n">yml</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="err">└──</span> <span class="n">jmx_prometheus_javaagent</span><span class="o">-</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="n">jar</span>
<span class="err">└──</span> <span class="n">liberty</span>
    <span class="err">└──</span> <span class="n">server</span><span class="p">.</span><span class="n">xml</span>
    <span class="err">└──</span> <span class="n">server</span><span class="p">.</span><span class="n">env</span>
    <span class="err">└──</span> <span class="n">jvm</span><span class="p">.</span><span class="k">options</span>
</pre></div>


<h2 id="create-the-docker-dockerfile">Create the Docker Dockerfile</h2>
<p>Once the application code changes have been made and WebSphere Liberty configuration has been created the next step is to build a Docker image that contains the application and configuration. The build script to create a Docker image is a <a href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a>.</p>
<p>The <code>Dockerfile</code> for the Customer Order Services application is shown below. The file can be found <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/liberty/Dockerfile">here</a></p>
<div class="codehilite"><pre><span></span><span class="k">FROM</span> <span class="n">ibmcom</span><span class="o">/</span><span class="n">websphere</span><span class="o">-</span><span class="n">liberty</span><span class="p">:</span><span class="n">kernel</span><span class="o">-</span><span class="n">ubi</span><span class="o">-</span><span class="k">min</span>

<span class="k">COPY</span> <span class="c1">--chown=1001:0 ./liberty/server.xml /config</span>
<span class="k">COPY</span> <span class="c1">--chown=1001:0 ./liberty/jvm.options /config</span>

<span class="n">ARG</span> <span class="n">SSL</span><span class="o">=</span><span class="k">false</span>
<span class="n">ARG</span> <span class="n">MP_MONITORING</span><span class="o">=</span><span class="k">false</span>
<span class="n">ARG</span> <span class="n">HTTP_ENDPOINT</span><span class="o">=</span><span class="k">false</span>

<span class="k">COPY</span> <span class="c1">--chown=1001:0 ./CustomerOrderServicesApp/target/CustomerOrderServicesApp-0.1.0-SNAPSHOT.ear /config/apps/CustomerOrderServicesApp-0.1.0-SNAPSHOT.ear</span>
<span class="k">COPY</span> <span class="c1">--chown=1001:0 ./resources/ /opt/ibm/wlp/usr/shared/resources/</span>

<span class="k">USER</span> <span class="mi">1001</span>
<span class="n">RUN</span> <span class="n">configure</span><span class="p">.</span><span class="n">sh</span>
</pre></div>


<p>IBM provides a set of WebSphere Liberty <a href="https://hub.docker.com/_/websphere-liberty">Docker images</a> that are part of the IBM CloudPak for Applications. This scenario uses the Docker images that are based on the <a href="https://www.redhat.com/en/blog/introducing-red-hat-universal-base-image">RedHat Universal Base Image</a>. The <code>ibmcom/websphere-liberty:kernel-ubi-min</code> image contains only the smallest components of the Liberty server. The features used by the application are loaded in to the Docker image later in the <code>RUN configure.sh</code> step.</p>
<p>The first two <code>COPY</code> commands copy the <code>server.xml</code> and <code>jvm.options</code> files to the <code>/config</code> folder on the WebSphere Liberty image. Later in the Dockerfile there are other <code>COPY</code> commands to copy the application that has been created by Maven to <code>/config/apps</code> and the <code>DB2 drivers</code>, <code>JMX exporter JAR</code> and <code>JMX exporter configuration file</code> to the shared resources folder for Liberty.</p>
<h2 id="run-the-application-locally">Run the application locally</h2>
<p>Now that the application code changes have been made, the WebSphere Liberty configuration has been created and the Dockerfile is ready, the next step is to build a Docker image and run an instance locally to validate that the application runs correctly.</p>
<ol>
<li>Clone the GitHub repo and switch to the <code>liberty</code> branch using the following steps:  </li>
</ol>
<div class="codehilite"><pre><span></span><span class="nv">git</span> <span class="nv">clone</span> <span class="nv">SOME_REPO</span>
<span class="nv">cd</span> <span class="nv">cloudpak</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">applications</span>
<span class="nv">git</span> <span class="nv">checkout</span> <span class="nv">liberty</span>
</pre></div>


<ol>
<li>Use Maven to build the application  </li>
</ol>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> CustomerOrderServicesProject
mvn clean package
</pre></div>


<p>The <code>CustomerOrderServicesApp-0.1.0-SNAPSHOT.ear</code> file should now be present in <code>CustomerOrderServicesApp/target/</code><br />
3. Modify the <code>liberty/server.env</code> file for your environment as shown below:</p>
<div class="codehilite"><pre><span></span><span class="nv">DB2_HOST</span><span class="o">=</span><span class="m">172</span>.16.52.252
<span class="nv">DB2_PORT</span><span class="o">=</span><span class="m">50000</span>
<span class="nv">DB2_DBNAME</span><span class="o">=</span>ORDERDB
<span class="nv">DB2_USER</span><span class="o">=</span>db2inst1
<span class="nv">DB2_PASSWORD</span><span class="o">=</span>db2inst1
</pre></div>


<ol>
<li>Build the Docker image using the following commands:</li>
</ol>
<div class="codehilite"><pre><span></span><span class="nv">cd</span> ..<span class="o">/</span><span class="nv">cloudpak</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">applications</span>
<span class="nv">docker</span> <span class="nv">build</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">customerorderservices</span><span class="o">-</span><span class="nv">local</span>:<span class="mi">1</span>.<span class="mi">0</span> .
</pre></div>


<p>The end of the <code>docker build</code> command output should be similar to that shown below:  </p>
<div class="codehilite"><pre><span></span><span class="p">...</span>
<span class="k">All</span> <span class="n">assets</span> <span class="n">were</span> <span class="n">successfully</span> <span class="n">installed</span><span class="p">.</span>

<span class="k">Start</span> <span class="n">product</span> <span class="n">validation</span><span class="p">...</span>
<span class="n">Product</span> <span class="n">validation</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="o">+</span> <span class="n">sort</span> <span class="o">-</span><span class="n">z</span>
<span class="o">+</span> <span class="n">xargs</span> <span class="o">-</span><span class="mi">0</span> <span class="o">-</span><span class="n">n</span> <span class="mi">1</span> <span class="o">-</span><span class="n">r</span> <span class="o">-</span><span class="n">I</span> <span class="s1">&#39;{}&#39;</span> <span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="s1">&#39;{}&#39;</span> <span class="c1">--installLocation /opt/ibm/wlp</span>
<span class="o">+</span> <span class="n">find</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">fixes</span> <span class="o">-</span><span class="k">type</span> <span class="n">f</span> <span class="o">-</span><span class="n">name</span> <span class="s1">&#39;*.jar&#39;</span> <span class="o">-</span><span class="n">print0</span>
<span class="o">+</span> <span class="n">xargs</span> <span class="o">-</span><span class="mi">0</span> <span class="o">-</span><span class="n">r</span> <span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="k">g</span><span class="o">+</span><span class="n">rw</span>
<span class="o">+</span> <span class="n">find</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">wlp</span> <span class="o">-</span><span class="n">perm</span> <span class="o">-</span><span class="k">g</span><span class="o">=</span><span class="n">w</span> <span class="o">-</span><span class="n">print0</span>
<span class="o">+</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">wlp</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">server</span> <span class="k">start</span>

<span class="n">Starting</span> <span class="n">server</span> <span class="n">defaultServer</span><span class="p">.</span>
<span class="n">Server</span> <span class="n">defaultServer</span> <span class="n">started</span> <span class="k">with</span> <span class="n">process</span> <span class="n">ID</span> <span class="mi">127</span><span class="p">.</span>
<span class="o">+</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">wlp</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">server</span> <span class="n">stop</span>

<span class="n">Stopping</span> <span class="n">server</span> <span class="n">defaultServer</span><span class="p">.</span>
<span class="n">Server</span> <span class="n">defaultServer</span> <span class="n">stopped</span><span class="p">.</span>
<span class="o">+</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="k">output</span><span class="o">/</span><span class="n">resources</span><span class="o">/</span><span class="k">security</span><span class="o">/</span> <span class="o">/</span><span class="k">output</span><span class="o">/</span><span class="n">messaging</span> <span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">console</span><span class="p">.</span><span class="n">log</span> <span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">messages</span><span class="p">.</span><span class="n">log</span> <span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">messages_19</span><span class="p">.</span><span class="mi">06</span><span class="p">.</span><span class="mi">25</span><span class="n">_16</span><span class="p">.</span><span class="mi">12</span><span class="p">.</span><span class="mi">03</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="n">log</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">wlp</span><span class="o">/</span><span class="k">output</span><span class="o">/</span><span class="p">.</span><span class="n">classCache</span>
<span class="o">+</span> <span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="k">g</span><span class="o">+</span><span class="n">rwx</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">wlp</span><span class="o">/</span><span class="k">output</span><span class="o">/</span><span class="n">defaultServer</span>
<span class="o">+</span> <span class="n">find</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">wlp</span> <span class="o">-</span><span class="k">type</span> <span class="n">d</span> <span class="o">-</span><span class="n">perm</span> <span class="o">-</span><span class="k">g</span><span class="o">=</span><span class="n">x</span> <span class="o">-</span><span class="n">print0</span>
<span class="o">+</span> <span class="n">xargs</span> <span class="o">-</span><span class="mi">0</span> <span class="o">-</span><span class="n">r</span> <span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="k">g</span><span class="o">+</span><span class="n">rwx</span>
<span class="n">Removing</span> <span class="n">intermediate</span> <span class="n">container</span> <span class="n">c08b8b001320</span>
 <span class="c1">---&gt; 2897b25fa45e</span>
<span class="n">Successfully</span> <span class="n">built</span> <span class="mi">2897</span><span class="n">b25fa45e</span>
<span class="n">Successfully</span> <span class="n">tagged</span> <span class="n">customerorderservices</span><span class="o">-</span><span class="k">local</span><span class="p">:</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span>
</pre></div>


<ol>
<li>Run the newly created Docker image using the commands below:</li>
</ol>
<div class="codehilite"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="c1">--name customerorderservices-local -d -p 9081:9081 -p 9443:9443 -v server.env:/config/server.env customerorderservices-local:1.0</span>
</pre></div>


<p>This command injects the server.env file in the correct location so that it is loaded by WebSphere Liberty on startup.<br />
6. Check the logs for the WebSphere Liberty server using:</p>
<div class="codehilite"><pre><span></span><span class="n">docker</span> <span class="n">logs</span> <span class="n">customerorderservices</span><span class="o">-</span><span class="k">local</span>
</pre></div>


<p>The result should be that the server is started without error and the application is loaded:</p>
<div class="codehilite"><pre><span></span><span class="nv">root</span>@<span class="nv">gas</span><span class="o">-</span><span class="nv">twas90</span>:<span class="o">~/</span><span class="nv">djm</span><span class="o">/</span><span class="nv">latest</span><span class="o">/</span><span class="nv">cloudpak</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">applications</span><span class="o">/</span><span class="nv">liberty</span># <span class="nv">docker</span> <span class="nv">logs</span> <span class="nv">customerorderservices</span><span class="o">-</span><span class="nv">local</span>

<span class="nv">Launching</span> <span class="nv">defaultServer</span> <span class="ss">(</span><span class="nv">WebSphere</span> <span class="nv">Application</span> <span class="nv">Server</span> <span class="mi">19</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">5</span><span class="o">/</span><span class="nv">wlp</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">0</span>.<span class="mi">28</span>.<span class="nv">cl190520190522</span><span class="o">-</span><span class="mi">2227</span><span class="ss">)</span> <span class="nv">on</span> <span class="nv">IBM</span> <span class="nv">J9</span> <span class="nv">VM</span>, <span class="nv">version</span> <span class="mi">8</span>.<span class="mi">0</span>.<span class="mi">5</span>.<span class="mi">36</span> <span class="o">-</span> <span class="nv">pxa6480sr5fp36</span><span class="o">-</span><span class="mi">20190510</span><span class="nv">_01</span><span class="ss">(</span><span class="nv">SR5</span> <span class="nv">FP36</span><span class="ss">)</span> <span class="ss">(</span><span class="nv">en_US</span><span class="ss">)</span>
[<span class="nv">AUDIT</span>   ] <span class="nv">CWWKE0001I</span>: <span class="nv">The</span> <span class="nv">server</span> <span class="nv">defaultServer</span> <span class="nv">has</span> <span class="nv">been</span> <span class="nv">launched</span>.
[<span class="nv">AUDIT</span>   ] <span class="nv">CWWKE0100I</span>: <span class="nv">This</span> <span class="nv">product</span> <span class="nv">is</span> <span class="nv">licensed</span> <span class="k">for</span> <span class="nv">development</span>, <span class="nv">and</span> <span class="nv">limited</span> <span class="nv">production</span> <span class="nv">use</span>. <span class="nv">The</span> <span class="nv">full</span> <span class="nv">license</span> <span class="nv">terms</span> <span class="nv">can</span> <span class="nv">be</span> <span class="nv">viewed</span> <span class="nv">here</span>: <span class="nv">https</span>:<span class="o">//</span><span class="nv">public</span>.<span class="nv">dhe</span>.<span class="nv">ibm</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">ibmdl</span><span class="o">/</span><span class="nv">export</span><span class="o">/</span><span class="nv">pub</span><span class="o">/</span><span class="nv">software</span><span class="o">/</span><span class="nv">websphere</span><span class="o">/</span><span class="nv">wasdev</span><span class="o">/</span><span class="nv">license</span><span class="o">/</span><span class="nv">base_ilan</span><span class="o">/</span><span class="nv">ilan</span><span class="o">/</span><span class="mi">19</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">5</span><span class="o">/</span><span class="nv">lafiles</span><span class="o">/</span><span class="nv">en</span>.<span class="nv">html</span>
[<span class="nv">AUDIT</span>   ] <span class="nv">CWWKG0093A</span>: <span class="nv">Processing</span> <span class="nv">configuration</span> <span class="nv">drop</span><span class="o">-</span><span class="nv">ins</span> <span class="nv">resource</span>: <span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">ibm</span><span class="o">/</span><span class="nv">wlp</span><span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">servers</span><span class="o">/</span><span class="nv">defaultServer</span><span class="o">/</span><span class="nv">configDropins</span><span class="o">/</span><span class="nv">defaults</span><span class="o">/</span><span class="nv">keystore</span>.<span class="nv">xml</span>
[<span class="nv">AUDIT</span>   ] <span class="nv">CWWKG0102I</span>: <span class="nv">Found</span> <span class="nv">conflicting</span> <span class="nv">settings</span> <span class="k">for</span> <span class="nv">defaultKeyStore</span> <span class="nv">instance</span> <span class="nv">of</span> <span class="nv">keyStore</span> <span class="nv">configuration</span>.
  <span class="nv">Property</span> <span class="nv">password</span> <span class="nv">has</span> <span class="nv">conflicting</span> <span class="nv">values</span>:
    <span class="nv">Secure</span> <span class="nv">value</span> <span class="nv">is</span> <span class="nv">set</span> <span class="nv">in</span> <span class="nv">file</span>:<span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">ibm</span><span class="o">/</span><span class="nv">wlp</span><span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">servers</span><span class="o">/</span><span class="nv">defaultServer</span><span class="o">/</span><span class="nv">configDropins</span><span class="o">/</span><span class="nv">defaults</span><span class="o">/</span><span class="nv">keystore</span>.<span class="nv">xml</span>.
    <span class="nv">Secure</span> <span class="nv">value</span> <span class="nv">is</span> <span class="nv">set</span> <span class="nv">in</span> <span class="nv">file</span>:<span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">ibm</span><span class="o">/</span><span class="nv">wlp</span><span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">servers</span><span class="o">/</span><span class="nv">defaultServer</span><span class="o">/</span><span class="nv">server</span>.<span class="nv">xml</span>.
  <span class="nv">Property</span> <span class="nv">password</span> <span class="nv">will</span> <span class="nv">be</span> <span class="nv">set</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">value</span> <span class="nv">defined</span> <span class="nv">in</span> <span class="nv">file</span>:<span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">ibm</span><span class="o">/</span><span class="nv">wlp</span><span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">servers</span><span class="o">/</span><span class="nv">defaultServer</span><span class="o">/</span><span class="nv">server</span>.<span class="nv">xml</span>.

[<span class="nv">AUDIT</span>   ] <span class="nv">CWWKZ0058I</span>: <span class="nv">Monitoring</span> <span class="nv">dropins</span> <span class="k">for</span> <span class="nv">applications</span>.
[<span class="nv">AUDIT</span>   ] <span class="nv">CWWKS4104A</span>: <span class="nv">LTPA</span> <span class="nv">keys</span> <span class="nv">created</span> <span class="nv">in</span> <span class="mi">1</span>.<span class="mi">573</span> <span class="nv">seconds</span>. <span class="nv">LTPA</span> <span class="nv">key</span> <span class="nv">file</span>: <span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">ibm</span><span class="o">/</span><span class="nv">wlp</span><span class="o">/</span><span class="nv">output</span><span class="o">/</span><span class="nv">defaultServer</span><span class="o">/</span><span class="nv">resources</span><span class="o">/</span><span class="nv">security</span><span class="o">/</span><span class="nv">ltpa</span>.<span class="nv">keys</span>
[<span class="nv">AUDIT</span>   ] <span class="nv">CWPKI0803A</span>: <span class="nv">SSL</span> <span class="nv">certificate</span> <span class="nv">created</span> <span class="nv">in</span> <span class="mi">5</span>.<span class="mi">334</span> <span class="nv">seconds</span>. <span class="nv">SSL</span> <span class="nv">key</span> <span class="nv">file</span>: <span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">ibm</span><span class="o">/</span><span class="nv">wlp</span><span class="o">/</span><span class="nv">output</span><span class="o">/</span><span class="nv">defaultServer</span><span class="o">/</span><span class="nv">resources</span><span class="o">/</span><span class="nv">security</span><span class="o">/</span><span class="nv">key</span>.<span class="nv">p12</span>
[<span class="nv">AUDIT</span>   ] <span class="nv">CWWKT0016I</span>: <span class="nv">Web</span> <span class="nv">application</span> <span class="nv">available</span> <span class="ss">(</span><span class="nv">default_host</span><span class="ss">)</span>: <span class="nv">http</span>:<span class="o">//</span><span class="mi">57</span><span class="nv">edcfea336d</span>:<span class="mi">9080</span><span class="o">/</span><span class="nv">CustomerOrderServicesWeb</span><span class="o">/</span>
[<span class="nv">AUDIT</span>   ] <span class="nv">CWWKT0016I</span>: <span class="nv">Web</span> <span class="nv">application</span> <span class="nv">available</span> <span class="ss">(</span><span class="nv">default_host</span><span class="ss">)</span>: <span class="nv">http</span>:<span class="o">//</span><span class="mi">57</span><span class="nv">edcfea336d</span>:<span class="mi">9080</span><span class="o">/</span><span class="nv">CustomerOrderServicesTest</span><span class="o">/</span>
[<span class="nv">AUDIT</span>   ] <span class="nv">CWWKZ0001I</span>: <span class="nv">Application</span> <span class="nv">CustomerOrderServicesApp</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">1</span>.<span class="mi">0</span><span class="o">-</span><span class="nv">SNAPSHOT</span>.<span class="nv">ear</span> <span class="nv">started</span> <span class="nv">in</span> <span class="mi">2</span>.<span class="mi">837</span> <span class="nv">seconds</span>.
[<span class="nv">AUDIT</span>   ] <span class="nv">CWWKF0012I</span>: <span class="nv">The</span> <span class="nv">server</span> <span class="nv">installed</span> <span class="nv">the</span> <span class="nv">following</span> <span class="nv">features</span>: [<span class="nv">appSecurity</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">0</span>, <span class="nv">beanValidation</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">0</span>, <span class="nv">distributedMap</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">0</span>, <span class="nv">ejbLite</span><span class="o">-</span><span class="mi">3</span>.<span class="mi">1</span>, <span class="nv">el</span><span class="o">-</span><span class="mi">3</span>.<span class="mi">0</span>, <span class="nv">federatedRegistry</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">0</span>, <span class="nv">jaxrs</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">1</span>, <span class="nv">jdbc</span><span class="o">-</span><span class="mi">4</span>.<span class="mi">1</span>, <span class="nv">jndi</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">0</span>, <span class="nv">jpa</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">0</span>, <span class="nv">json</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">0</span>, <span class="nv">jsp</span><span class="o">-</span><span class="mi">2</span>.<span class="mi">3</span>, <span class="nv">ldapRegistry</span><span class="o">-</span><span class="mi">3</span>.<span class="mi">0</span>, <span class="nv">localConnector</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">0</span>, <span class="nv">monitor</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">0</span>, <span class="nv">servlet</span><span class="o">-</span><span class="mi">3</span>.<span class="mi">1</span>, <span class="nv">ssl</span><span class="o">-</span><span class="mi">1</span>.<span class="mi">0</span>].
[<span class="nv">AUDIT</span>   ] <span class="nv">CWWKF0011I</span>: <span class="nv">The</span> <span class="nv">defaultServer</span> <span class="nv">server</span> <span class="nv">is</span> <span class="nv">ready</span> <span class="nv">to</span> <span class="nv">run</span> <span class="nv">a</span> <span class="nv">smarter</span> <span class="nv">planet</span>. <span class="nv">The</span> <span class="nv">defaultServer</span> <span class="nv">server</span> <span class="nv">started</span> <span class="nv">in</span> <span class="mi">12</span>.<span class="mi">838</span> <span class="nv">seconds</span>.
</pre></div>


<ol>
<li>
<p>Access the application in a browser using <code>https://127.0.0.1:9443/CustomerOrderServicesWeb</code>. Login using <code>rbarcia</code> and <code>bl0wfish</code> and then add an item to the shopping cart<br />
<img alt="App" src="../images/liberty-build/app.jpg" /></p>
</li>
<li>
<p>Validate that the <code>/metrics</code> endpoint is available at <code>http://127.0.0.1:9081/metrics</code><br />
<img alt="Metrics" src="../images/liberty-build/metrics.jpg" /></p>
</li>
<li>
<p>Stop the Docker container using the commands below:  </p>
</li>
</ol>
<div class="codehilite"><pre><span></span>docker stop customerorderservices-local
</pre></div>


<h2 id="review-and-next-steps">Review and Next Steps</h2>
<p>The intention of this traditional WebSphere V855 --&gt; Liberty (Private Cloud) scenario is to migrate the Customer Order Services application to the cloud-ready new runtime with minimal code changes.</p>
<p>In this section you have moved the application to WebSphere Liberty and tested it locally in a Docker container.</p>
<p>Now proceed to the <a href="../liberty-deploy/">Liberty - Deploy</a> section where the process of automating the deployment of the application to a Kubernetes runtime will be covered step-by-step</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>