



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>traditional WebSphere - Build - Application Modernization</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#traditional-websphere-build" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Application Modernization" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Application Modernization
            </span>
            <span class="md-header-nav__topic">
              
                traditional WebSphere - Build
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    ibm-cloud-architecture/cloudpak-for-applications
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Application Modernization" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Application Modernization
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    ibm-cloud-architecture/cloudpak-for-applications
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../liberty/" title="Runtime modernization" class="md-nav__link">
      Runtime modernization
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../spring/" title="Spring modernization" class="md-nav__link">
      Spring modernization
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../" title="Operational modernization" class="md-nav__link">
      Operational modernization
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-a-traditional-websphere-docker-container-using-existing-wsadmin-scripts" class="md-nav__link">
    Building a traditional WebSphere Docker container using existing wsadmin scripts.
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-the-image" class="md-nav__link">
    Build the image
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-the-image" class="md-nav__link">
    Test the image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modifying-configuration-without-rebuilding-container" class="md-nav__link">
    Modifying Configuration without rebuilding container
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-the-application" class="md-nav__link">
    Verify the application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-put-your-passwords-in-secrets" class="md-nav__link">
    Advanced:  Put your passwords in Secrets!
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/edit/master/docs/was90/tWAS-build.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="traditional-websphere-build">traditional WebSphere - Build</h1>
<p>This section covers how to containerize an existing application running on traditional WebSphere Application Server.  To do this we have two options on how to migrate.  Option 1 (descibed below): Create or use existing wsadmin scripts.  Option 2: <a href="tWAS-build-WCMT4IC.md">Use the WebSphere Configuration Migration Tool for IBM Cloud (WCMT4IC) to extract the configuration from your existing traditional WebSphere Application Server environment.</a></p>
<p>We're going to focus on the method of using existing scripts, since it better matches the best practice for CI/CD pipelines.</p>
<p>Once the environment is running as is, we'll learn how to make modifications to the configuration without having to rebuild your container, and why this is important.</p>
<p>The final versions of the files created in this section can be found in the <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/tree/was90">was90</a> branch of this repo</p>
<h2 id="summary">Summary:</h2>
<p>This section has the following steps:</p>
<ul>
<li><a href="./#building-a-traditional-websphere-docker-container-using-existing-wsadmin-scripts">Build the image using existing scripts</a></li>
<li><a href="./#test-the-image">Test the application locally</a></li>
<li><a href="./#modifying-configuration-without-rebuilding-container">Using environment variables in properties files to allow configuration to be injected in to the runtime environment dynamically.</a></li>
<li><a href="./#advanced--put-your-passwords-in-secrets">Advanced: put your passwords in secrets.</a></li>
</ul>
<h2 id="building-a-traditional-websphere-docker-container-using-existing-wsadmin-scripts">Building a traditional WebSphere Docker container using existing wsadmin scripts.</h2>
<p>For this example, we're going to use the Customer Order Application as an example.  We already have a wsadmin script which will configure the environment and install the application.  </p>
<p>Review the contents of the <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/was90/tWAS/cosConfig.py">wsadmin script</a>.<br />
This is a legacy application which runs on older frameworks; most notably it uses JPA 2.0 and JAX-RS 1.1.  These are not the default in WAS 9 (as they are in WAS8.5.5, but they are supported).  It is important to modify these settings in the scripts if you don't want to make modifications to your application at this time.</p>
<p>We are going to install the application using a properties file, which is an alternative way to install the application, or apply any configuration. The application could also be installed using the wsadmin jython script, but we chose to use the properties file to show the two methods configurations can be applied at build time.
Review the contents of the <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/was90/tWAS/app-update.props">properties file</a></p>
<p>To run these files during container creation we copy them into <code>/work/config/</code> folder using the Dockerfile.  Then we run the <code>/work/configure.sh</code> which will start the server and run the scripts and apply the properties file configuration.  We also copy the db2 drivers and the application, and anything else the applications needs into the container.   </p>
<p>Review the contents of the <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/was90/Dockerfile">Dockerfile</a>.</p>
<div class="codehilite"><pre><span></span><span class="nv">ARG</span> <span class="nv">WEBSPHERE_VERSION</span><span class="o">=</span><span class="mi">9</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">11</span>

# <span class="nv">Migration</span> <span class="nv">requires</span> <span class="nv">websphere</span><span class="o">-</span><span class="nv">traditional</span> <span class="o">&gt;=</span> <span class="mi">9</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">11</span>
<span class="nv">FROM</span> <span class="nv">ibmcom</span><span class="o">/</span><span class="nv">websphere</span><span class="o">-</span><span class="nv">traditional</span>:$<span class="nv">WEBSPHERE_VERSION</span> <span class="nv">as</span> <span class="nv">migration</span>

#<span class="nv">Hardcode</span> <span class="nv">password</span> <span class="k">for</span> <span class="nv">admin</span> <span class="nv">console</span>
<span class="nv">COPY</span> <span class="o">--</span><span class="nv">chown</span><span class="o">=</span><span class="nv">was</span>:<span class="mi">0</span> <span class="nv">tWAS</span><span class="o">/</span><span class="nv">PASSWORD</span> <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">PASSWORD</span>

<span class="nv">COPY</span> <span class="o">--</span><span class="nv">chown</span><span class="o">=</span><span class="nv">was</span>:<span class="mi">0</span> <span class="nv">resources</span><span class="o">/</span><span class="nv">db2</span><span class="o">/</span> <span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">IBM</span><span class="o">/</span><span class="nv">db2drivers</span><span class="o">/</span>

<span class="nv">COPY</span> <span class="o">--</span><span class="nv">chown</span><span class="o">=</span><span class="nv">was</span>:<span class="mi">0</span> <span class="nv">resources</span><span class="o">/</span><span class="nv">jmx_exporter</span><span class="o">/</span><span class="nv">jmx_prometheus_javaagent</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">11</span>.<span class="mi">0</span>.<span class="nv">jar</span> <span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">IBM</span><span class="o">/</span><span class="nv">jmx_exporter</span><span class="o">/</span>
<span class="nv">COPY</span> <span class="o">--</span><span class="nv">chown</span><span class="o">=</span><span class="nv">was</span>:<span class="mi">0</span> <span class="nv">resources</span><span class="o">/</span><span class="nv">jmx_exporter</span><span class="o">/</span><span class="nv">jmx</span><span class="o">-</span><span class="nv">config</span>.<span class="nv">yaml</span> <span class="o">/</span><span class="nv">opt</span><span class="o">/</span><span class="nv">IBM</span><span class="o">/</span><span class="nv">jmx_exporter</span><span class="o">/</span>

# <span class="nv">Uncomment</span> <span class="nv">to</span> <span class="nv">test</span> <span class="nv">locally</span>
#<span class="nv">COPY</span> <span class="o">--</span><span class="nv">chown</span><span class="o">=</span><span class="nv">was</span>:<span class="mi">0</span> <span class="nv">tWAS</span><span class="o">/</span><span class="nv">jvm</span>.<span class="nv">props</span> <span class="o">/</span><span class="nv">work</span><span class="o">/</span><span class="nv">config</span>

<span class="nv">COPY</span> <span class="o">--</span><span class="nv">chown</span><span class="o">=</span><span class="nv">was</span>:<span class="mi">0</span> <span class="nv">tWAS</span><span class="o">/</span><span class="nv">cosConfig</span>.<span class="nv">py</span> <span class="o">/</span><span class="nv">work</span><span class="o">/</span><span class="nv">config</span><span class="o">/</span>

<span class="nv">COPY</span> <span class="o">--</span><span class="nv">chown</span><span class="o">=</span><span class="nv">was</span>:<span class="mi">0</span> <span class="nv">tWAS</span><span class="o">/</span><span class="nv">app</span><span class="o">-</span><span class="nv">update</span>.<span class="nv">props</span>  <span class="o">/</span><span class="nv">work</span><span class="o">/</span><span class="nv">config</span><span class="o">/</span><span class="nv">app</span><span class="o">-</span><span class="nv">update</span>.<span class="nv">props</span>
<span class="nv">COPY</span> <span class="o">--</span><span class="nv">chown</span><span class="o">=</span><span class="nv">was</span>:<span class="mi">0</span> <span class="nv">tWAS</span><span class="o">/</span><span class="nv">CustomerOrderServicesApp</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">1</span>.<span class="mi">0</span><span class="o">-</span><span class="nv">SNAPSHOT</span>.<span class="nv">ear</span> <span class="o">/</span><span class="nv">work</span><span class="o">/</span><span class="nv">config</span><span class="o">/</span><span class="nv">CustomerOrderServicesApp</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">1</span>.<span class="mi">0</span><span class="o">-</span><span class="nv">SNAPSHOT</span>.<span class="nv">ear</span>

<span class="nv">RUN</span> <span class="o">/</span><span class="nv">work</span><span class="o">/</span><span class="nv">configure</span>.<span class="nv">sh</span>
</pre></div>


<p>Let's try it...</p>
<h3 id="build-the-image">Build the image</h3>
<p>Now it's time to build the image. This guide assumes you have Docker installed.</p>
<p>The code existing in the was90 branch.  Clone the branch to copy the files to your system</p>
<div class="codehilite"><pre><span></span><span class="nv">git</span> <span class="nv">clone</span> <span class="o">--</span><span class="nv">branch</span> <span class="nv">was90</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">ibm</span><span class="o">-</span><span class="nv">cloud</span><span class="o">-</span><span class="nv">architecture</span><span class="o">/</span><span class="nv">cloudpak</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">applications</span>.<span class="nv">git</span>
<span class="nv">cd</span> <span class="nv">cloudpak</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="nv">applications</span>
<span class="nv">docker</span> <span class="nv">build</span> <span class="o">--</span><span class="nv">tag</span> <span class="nv">customer</span><span class="o">-</span><span class="nv">order</span><span class="o">-</span><span class="nv">app</span> .
</pre></div>


<p>You should see the following messages if image was successfully built (image id may vary):</p>
<div class="codehilite"><pre><span></span><span class="n">Successfully</span> <span class="n">built</span> <span class="n">f8d3eafdd30a</span>
<span class="n">Successfully</span> <span class="n">tagged</span> <span class="n">customer</span><span class="o">-</span><span class="k">order</span><span class="o">-</span><span class="n">app</span><span class="p">:</span><span class="n">latest</span>
</pre></div>


<p>Validate that image is in the repository using command (you should also see original websphere-traditional image):</p>
<div class="codehilite"><pre><span></span><span class="err">$</span><span class="n">docker</span> <span class="n">images</span>
<span class="n">REPOSITORY</span>                                  <span class="n">TAG</span>                 <span class="n">IMAGE</span> <span class="n">ID</span>            <span class="n">CREATED</span>             <span class="k">SIZE</span>
<span class="n">customer</span><span class="o">-</span><span class="k">order</span><span class="o">-</span><span class="n">app</span>                          <span class="n">latest</span>              <span class="n">f8d3eafdd30a</span>        <span class="mi">3</span> <span class="n">days</span> <span class="n">ago</span>          <span class="mi">1</span><span class="p">.</span><span class="mi">85</span><span class="n">GB</span>
<span class="n">ibmcom</span><span class="o">/</span><span class="n">websphere</span><span class="o">-</span><span class="n">traditional</span>                <span class="mi">9</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span>            <span class="mi">2985</span><span class="n">c9be759f</span>        <span class="mi">10</span> <span class="n">days</span> <span class="n">ago</span>         <span class="mi">1</span><span class="p">.</span><span class="mi">78</span><span class="n">GB</span>
</pre></div>


<h2 id="test-the-image">Test the image</h2>
<p>To test the image locally you are also going to need a database to connect to locally.  We aren't going to go into this much.  Since we want the DB2 and tWAS containers to be able to talk to each other we create a network they can share</p>
<div class="codehilite"><pre><span></span><span class="err">$</span><span class="n">docker</span> <span class="n">network</span> <span class="k">create</span> <span class="n">customer</span><span class="o">-</span><span class="k">order</span>
</pre></div>


<p>Now we start DB2.  This DB2 contains scripts to populate the database with sample data for our application on startup.</p>
<div class="codehilite"><pre><span></span><span class="err">$</span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="c1">--network customer-order --privileged=true -e LICENSE=accept -e DB2INST1_PASSWORD=db2inst1 -e DBNAME=orderdb --name db2-customer-order vandepol/db2-cos</span>
</pre></div>


<p>This take a while to start up since it creates the database from scratch.</p>
<p>to access this database from the tWAS container, we use the hostname = container name.  In this case the hostname would be <code>db2-customer-order</code></p>
<p>You are going to test the image in local Docker engine. Issue the following command to start the container:</p>
<div class="codehilite"><pre><span></span><span class="err">$</span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="c1">--network customer-order --name twas-customer-order -p 9443:9443 -p 9043:9043 customer-order-app:latest</span>
</pre></div>


<p>Check if container started successfully using command:</p>
<div class="codehilite"><pre><span></span><span class="mh">$d</span><span class="nv">ocker</span> <span class="nv">logs</span> <span class="o">-</span><span class="nv">f</span> <span class="mi">9</span><span class="nv">ee253a59956869c6</span>
<span class="nv">WASX7303I</span>: <span class="nv">The</span> <span class="nv">following</span> <span class="nv">options</span> <span class="nv">are</span> <span class="nv">passed</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">scripting</span> <span class="nv">environment</span> <span class="nv">and</span> <span class="nv">are</span> <span class="nv">available</span> <span class="nv">as</span> <span class="nv">arguments</span> <span class="nv">that</span> <span class="nv">are</span> <span class="nv">stored</span> <span class="nv">in</span> <span class="nv">the</span> <span class="nv">argv</span> <span class="nv">variable</span>: <span class="s2">&quot;</span><span class="s">[/work/config-ibm/webContainer.props]</span><span class="s2">&quot;</span>
<span class="nv">Starting</span> <span class="nv">server</span> ...................
<span class="nv">ADMU3000I</span>: <span class="nv">Server</span> <span class="nv">server1</span> <span class="nv">open</span> <span class="k">for</span> <span class="nv">e</span><span class="o">-</span><span class="nv">business</span><span class="c1">; process id is 494</span>
<span class="nv">HPEL</span> <span class="nv">is</span> <span class="nv">enabled</span>
<span class="nv">run</span> <span class="nv">logViewer</span>.<span class="nv">sh</span>
</pre></div>


<p>Right now the problem we have is that the database hostname in the scripts we used to configure the application doesn't match the hostname of the db2 docker container we started.  That leads us to our next section on modifying the configuration without rebuilding the container.  We could simply modify the jython scripts and change the hostname of the databases to <code>db2-customer-order</code>, however we're going to do it using configuration files.</p>
<h2 id="modifying-configuration-without-rebuilding-container">Modifying Configuration without rebuilding container</h2>
<p>When building the traditional WebSphere container there may be configuration you will want to add or change between environments.  You don't want to have to rebuild your container just because a database hostname changed, or for password changes.</p>
<p>To solve this problem, you can load configuration changes at server start-up using properties files. In this section we'll
show how to extract the configuration into properties files.  In the Deploy <a href="../tWAS-deploy/">section</a> we'll describe how to
create the configMaps and load them at server start-up when deploying using the cloudpak.</p>
<p>We have pre-extracted configuration files in the <a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/was90/runtimeConfig">runtimeConfig</a> folder, however if you want to extract your own you can follow the steps below.  </p>
<p>We start with a server environment setup and running with the resources defined as you desire. We can use the docker container we created above.  We can run this locally.   </p>
<p><code>docker run -d --rm --name twas-customer-order -p 9443:9443 -p 9043:9043 -p9080:9080 -v /myconfigs/:/etc/websphere/  customer-order-app:latest</code>  </p>
<p>Here we expose port <code>9043</code> for the WebSphere admin console.  We also mount a volume so that we can extract the properties files we're generating locally.</p>
<p>Next, we ssh into the container to execute commands to extract the configuration.  To enter the shell script of our container locally we run the command:  </p>
<p><code>docker exec -it twas-customer-order bash</code></p>
<p>Once in the container shell, we execute the following commands</p>
<p><code>/opt/IBM/WebSphere/AppServer/bin/wsadmin.sh -lang jython</code>  </p>
<p>you will be prompted for your credentials.  Use the credentials you would use in the Admin Console.
in our example we have:<code>wasadmin/passw0rd</code></p>
<p>Run the following command to extract the Datasource configuration and the Password information:  </p>
<div class="codehilite"><pre><span></span><span class="n">AdminTask</span><span class="p">.</span><span class="n">extractConfigProperties</span><span class="p">(</span><span class="err">&#39;</span><span class="p">[</span><span class="o">-</span><span class="n">propertiesFileName</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">websphere</span><span class="o">/</span><span class="n">Datasource</span><span class="p">.</span><span class="n">inds</span><span class="p">.</span><span class="n">props</span> <span class="o">-</span><span class="n">configData</span> <span class="n">DataSource</span><span class="o">=</span><span class="n">INDS</span> <span class="o">-</span><span class="n">options</span> <span class="p">[[</span><span class="n">PortablePropertiesFile</span> <span class="nb">true</span><span class="p">]]]</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">AdminTask</span><span class="p">.</span><span class="n">extractConfigProperties</span><span class="p">(</span><span class="err">&#39;</span><span class="p">[</span><span class="o">-</span><span class="n">propertiesFileName</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">websphere</span><span class="o">/</span><span class="n">Datasource</span><span class="p">.</span><span class="n">orderds</span><span class="p">.</span><span class="n">props</span> <span class="o">-</span><span class="n">configData</span> <span class="n">DataSource</span><span class="o">=</span><span class="n">OrderDS</span> <span class="o">-</span><span class="n">options</span> <span class="p">[[</span><span class="n">PortablePropertiesFile</span> <span class="nb">true</span><span class="p">]]]</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">AdminTask</span><span class="p">.</span><span class="n">extractConfigProperties</span><span class="p">(</span><span class="err">&#39;</span><span class="p">[</span><span class="o">-</span><span class="n">propertiesFileName</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">websphere</span><span class="o">/</span><span class="n">JAASAuth</span><span class="p">.</span><span class="n">db2password</span><span class="p">.</span><span class="n">props</span> <span class="o">-</span><span class="n">configData</span> <span class="n">Security</span><span class="o">=</span> <span class="o">-</span><span class="n">filterMechanism</span> <span class="n">SELECTED_SUBTYPES</span> <span class="o">-</span><span class="n">selectedSubTypes</span> <span class="p">[</span><span class="n">JAASAuthData</span><span class="p">]</span> <span class="o">-</span><span class="n">options</span> <span class="p">[[</span><span class="n">PortablePropertiesFile</span> <span class="nb">true</span><span class="p">]]]</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<p>The syntax for these commands can get complicated.  Documentation available <a href="https://www.ibm.com/support/knowledgecenter/SS7K4U_9.0.5/com.ibm.websphere.zseries.doc/ae/txml_7extractprops.html?origURL=SS7K4U_9.0.0/com.ibm.websphere.zseries.doc/ae/txml_7extractprops.html">here</a></p>
<p><strong>Sample Configuration Files</strong>  </p>
<p><a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/was90/tWAS/runtimeConfigs/Datasource.inds.props">Datasource.inds.props</a><br />
<a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/was90/tWAS/runtimeConfigs/Datasource.orderds.props">Datasource.orderds.props</a><br />
<a href="https://github.com/ibm-cloud-architecture/cloudpak-for-applications/blob/was90/tWAS/runtimeConfigs/JAASAuth.db2password.props">JAASAuth.db2password.props</a></p>
<p>If we want to change something in this configuration, we can make a change to these properties files.
To apply this to the container we can do this at container <strong>build</strong> time by copying the properties file into
the <code>/work/config</code> folder as described in the <a href="#modify-artifacts">Modifying Artifact section</a>.  </p>
<p>However, if you want to modify these at <strong>deploy</strong> time without rebuilding the docker container (ideal for passwords and database hostnames which change between environments), you can do a volume mount to
<code>/etc/websphere</code>, and these will be applied at server start-up.  </p>
<p>Let's try this!  </p>
<p>Open the properties files, <code>Datasource.inds.props</code> and <code>Datasource.orderds.props</code>.  Here let's change the server name of the database we're accessing to the name of our local db2 container we start above.   </p>
<div class="codehilite"><pre><span></span><span class="n">serverName</span><span class="o">=</span><span class="n">db2</span><span class="o">-</span><span class="n">customer</span><span class="o">-</span><span class="k">order</span> <span class="o">#</span><span class="n">String</span>
</pre></div>


<p>If our container is still running from before we want to stop it so that we can restart it and allow for the new properties to be loaded. <br />
<code>docker stop twas-customer-order</code></p>
<p>Restart the docker container and map the properties files again. Remember to connect to the same network of the db2 container we started above</p>
<p><code>docker run -d --rm --name twas-customer-order --network customer-order -p 9443:9443 -p 9043:9043 -p 9080:9080 -v /runtimeConfigs/:/etc/websphere/ customer-order-app:guide</code></p>
<p>We can look at the logs to see if the properties files are loaded.
<strong>TIP</strong>: the properties files MUST end in .props.  it will not detect different file types in the /etc/websphere folder at server start-up.</p>
<div class="codehilite"><pre><span></span>$ docker logs twas-customer-order -f
ENABLE_BASIC_LOGGING is
Configure logging mode
WASX7357I: By request, this scripting client is not connected to any server process. Certain configuration and application operations will be available in <span class="nb">local</span> mode.
+ Found config-files under /etc/websphere. Executing...
WASX7357I: By request, this scripting client is not connected to any server process. Certain configuration and application operations will be available in <span class="nb">local</span> mode.
WASX7303I: The following options are passed to the scripting environment and are available as arguments that are stored in the argv variable: <span class="s2">&quot;[/etc/websphere/Datasource.inds.props]&quot;</span>
WASX7357I: By request, this scripting client is not connected to any server process. Certain configuration and application operations will be available in <span class="nb">local</span> mode.
WASX7303I: The following options are passed to the scripting environment and are available as arguments that are stored in the argv variable: <span class="s2">&quot;[/etc/websphere/Datasource.orderds.props]&quot;</span>
WASX7357I: By request, this scripting client is not connected to any server process. Certain configuration and application operations will be available in <span class="nb">local</span> mode.
WASX7303I: The following options are passed to the scripting environment and are available as arguments that are stored in the argv variable: <span class="s2">&quot;[/etc/websphere/JAASAuth.db2password.props]&quot;</span>
WASX7357I: By request, this scripting client is not connected to any server process. Certain configuration and application operations will be available in <span class="nb">local</span> mode.
</pre></div>


<p>How we can log into the admin console to see our changes.  </p>
<h2 id="verify-the-application">Verify the application</h2>
<p>After the server is successfully started, you can connect to it using browser. Use http://localhost:9043/ibm/console to access admin console of the server running in the container. Login using your original credentials, that where migrated.</p>
<p><img alt="Console login" src="../images/tWAS-build/12-console.jpg" /></p>
<p>Also validate that application has successfully started</p>
<p><img alt="Application" src="../images/tWAS-build/13-app.jpg" /></p>
<p>And the Datasources were also migrated</p>
<p><img alt="Datasources" src="../images/tWAS-build/14-datasources.jpg" /></p>
<p>Finally open the application https://localhost:9443/CustomerOrderServicesWeb use <code>rbarcia/bl0wfish</code> for username and password if prompted.</p>
<p><img alt="Application page" src="../images/tWAS-build/15-running.jpg" /></p>
<p><strong>You have successfully migrated application to the traditional WebSphere Application Server container. Good job!</strong></p>
<h2 id="advanced-put-your-passwords-in-secrets">Advanced:  Put your passwords in Secrets!</h2>
<p>One issue with the above scenario is that the contents of the <a href="https://github.ibm.com/CASE/cloudpak-for-applications/blob/was90/tWAS/runtimeConfigs/JAASAuth.db2password.props">JAASAuth.db2password.props</a> is in plain text (or XOR encrypted...which isn't hard to crack).  Typically, we wouldn't want to store this in a properties file, which would then be stored as a configmap in Kubernetes.  We'd want to use secrets.  The way secrets work is that the properties loaded into the secret are loaded as environment variables at container start-up.  Ideally, we would want to replace values in the properties files we've loaded above with environment variables, this is currently not supported in the cloudpak (Feature request made to development); however, we have a work around to load these values ourselves.</p>
<p>First, we would replace a value with reference to an environment variable.
Let's use that the port number as an example again.</p>
<div class="codehilite"><pre><span></span><span class="n">syncQueryTimeoutWithTransactionTimeout</span><span class="o">=</span> <span class="o">#</span><span class="nb">boolean</span>
<span class="n">freeResourcesOnClose</span><span class="o">=</span><span class="k">false</span> <span class="o">#</span><span class="n">String</span>
<span class="n">traceFileCount</span><span class="o">=</span><span class="k">null</span>
<span class="o">**</span><span class="n">portNumber</span><span class="o">=!</span><span class="err">{</span><span class="n">inds</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="nb">number</span><span class="err">}</span> <span class="o">#</span><span class="nb">integer</span><span class="o">**</span>
<span class="n">stripTrailingZerosForDecimalNumbers</span><span class="o">=</span><span class="k">null</span>
<span class="n">translateForBitData</span><span class="o">=</span><span class="k">null</span>
<span class="n">webSphereDefaultQueryTimeout</span><span class="o">=</span> <span class="o">#</span><span class="nb">integer</span>
<span class="n">clientApplicationInformation</span><span class="o">=</span> <span class="o">#</span><span class="n">String</span>
</pre></div>


<p>Here we have assigned the <code>portNumber</code> to the environment variable <code>inds.port.number</code>.  </p>
<p>We have created a simple script to run prior to server startup which will replace all references to environment variables with the environment variable values.  </p>
<p>The script we created is available <a href="tWAS/envsubst.sh">here</a></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ch">#!/bin/sh</span>

mkdir /etc/websphere/orig
cp /etc/websphere/*.props /etc/websphere/orig/
<span class="k">for</span> f in <span class="k">$(</span>find /etc/websphere/orig/ -regex <span class="s1">&#39;.*\.props&#39;</span><span class="k">)</span><span class="p">;</span>
<span class="k">do</span>
  envsubst &lt; <span class="nv">$f</span> &gt; <span class="s2">&quot;/etc/websphere/</span><span class="k">$(</span>basename <span class="nv">$f</span><span class="k">)</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="k">done</span>
</pre></div>
</td></tr></table>

<p>One issue is that we need to install <code>envsubst</code> into the container, which is included inside the gettext package.  We have to run apt-get install to install this.  Next we need to copy our script into the container, and lastly we need to modify the startup command to run this command prior to server start-up.  Here is our solution to this:  </p>
<div class="codehilite"><pre><span></span><span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="k">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">gettext</span>
<span class="k">COPY</span> <span class="c1">--chown=was:0 envsubst-cmd.sh /work/</span>
<span class="n">CMD</span> <span class="p">[</span><span class="ss">&quot;sh&quot;</span><span class="p">,</span> <span class="ss">&quot;-c&quot;</span><span class="p">,</span> <span class="ss">&quot;/work/envsubst-cmd.sh &amp;&amp; /work/start_server.sh&quot;</span><span class="p">]</span>
</pre></div>


<p>Now we should be able to start up the container and pass a new value as an environment variable to change the port number.</p>
<p><code>docker run -d --rm --name customer-order-app -p9443:9443 -p 9043:9043 -v /myconfigs/:/etc/websphere/ -e inds.port.number=50002 customer-order-app:latest</code></p>
<p>To specify environment variable in the properties file you can replace the value with <code>${inds.port.number}</code></p>
<h2 id="conclusion">Conclusion</h2>
<p>In conclusion, we've taken our estisting traditional WebSphere application.  We've loaded the container with the server and application configuration.  We've installed the application, and modified the configuration if required.  This sets us up for integrating all of this into a CI/CD pipeline and then deploying this to Kubernetes.</p>
<p>We're on our way to the cloud!</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>